---
applyTo: "**/migrations/**,**/prisma/migrations/**,**/db/migrate/**"
---
# Migration Conventions

## Safety

- Migrations must be reversible (include both up and down)
- Never modify an existing migration that has been applied â€” create a new one
- Test migrations against a copy of production data before applying

## Naming

- Use descriptive names: `add_rate_limit_to_users`, not `migration_042`
- Include timestamp prefix as generated by your migration tool

## Data Integrity

- Add NOT NULL constraints only with a default value or after backfilling
- Add indexes for foreign keys and frequently queried columns
- Consider the impact on existing data before adding constraints

## Large Tables

- For tables with millions of rows, use batched operations
- Add indexes concurrently if supported by your database
- Consider zero-downtime migration patterns (expand-contract)

## Review Checklist

Before applying a migration:
- [ ] Reviewed the SQL it generates (not just the schema definition)
- [ ] Tested rollback (down migration)
- [ ] Checked for data loss risk
- [ ] Verified indexes are appropriate
- [ ] Estimated execution time on production-size data
